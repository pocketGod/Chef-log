<div class="page container">
  <a class="btn btn-ghost" routerLink="/dishes">← Back to Dishes</a>
  <h1 class="page__title">Dish Editor <span class="badge">setup</span></h1>

  @if (dish$ | async; as d) {
    <div class="editor">

      <!-- LEFT COLUMN -->
      <div class="editor__left">
        <!-- Basics -->
        <section class="card editor__card">
          <h3>Basics</h3>
          <div class="form-grid">
            <label class="field">
              <span class="field__label">Name</span>
              <input [(ngModel)]="local.name" (blur)="save()" />
            </label>

            <label class="field">
              <span class="field__label">Description</span>
              <textarea
                [(ngModel)]="local.description"
                (blur)="save()"
                rows="3"
                placeholder="Short notes about this dish (allergens, serving style, etc.)"
              ></textarea>
            </label>
          </div>
        </section>

        <!-- Serving & Suitability -->
        <section class="card editor__card">
          <h3>Serving &amp; Suitability</h3>
          <div class="form-grid form-grid--two">
            <label class="field">
              <span class="field__label">Base portions per person</span>
              <input
                type="number"
                step="0.1"
                min="0"
                [(ngModel)]="local.basePortionPerPerson"
                (blur)="save()"
              />
            </label>

            <label class="field">
              <span class="field__label">Diet</span>
              <select [(ngModel)]="local.diet" (change)="save()">
                <option value="meat">Meat</option>
                <option value="seafood">Seafood</option>
                <option value="vegeterian">Vegeterian</option>
                <option value="vegan">Vegan</option>
              </select>
            </label>

            <div class="field field--inline field--span-2">
              <app-check
                [label]="'Kid friendly'"
                [checked]="local.kidFriendly !== false"
                (checkedChange)="setKidFriendly($event)"
              />
            </div>
          </div>
        </section>
      </div>

      <!-- RIGHT COLUMN -->
      <aside class="editor__right">
        <section class="card editor__card">
          <div class="section-header">
            <h3>Ingredients</h3>
            <button class="btn" (click)="addIng()">➕ Add Ingredient</button>
          </div>

          <table class="table ingredients">
            <thead>
              <tr>
                <th>Name</th>
                <th>Unit</th>
                <th>Qty/Portion</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              @for (ing of local.ingredients; track ing.ingredientId + '_' + ing.unit) {
                <tr>
                  <!-- NAME -->
                  <td>
                    <input
                      [(ngModel)]="ing.ingredientName"
                      (ngModelChange)="onIngNameChange(ing, $event)"
                      placeholder="Search or add..."
                      [attr.list]="'ingredient-options-' + (ing.ingredientId || 'new')"
                    />
                    <datalist [id]="'ingredient-options-' + (ing.ingredientId || 'new')">
                      @for (opt of suggest; track opt.id) {
                        <option [value]="opt.name">{{ opt.name }}</option>
                      }
                    </datalist>
                  </td>

                  <!-- UNIT -->
                  <td>
                    <select [(ngModel)]="ing.unit" (ngModelChange)="markDirty()">
                      <option value="g">g</option>
                      <option value="kg">kg</option>
                      <option value="ml">ml</option>
                      <option value="l">l</option>
                      <option value="pcs">pcs</option>
                    </select>
                  </td>

                  <!-- QTY -->
                  <td>
                    <input
                      type="number"
                      step="0.01"
                      min="0"
                      [(ngModel)]="ing.qtyPerPortion"
                      (ngModelChange)="markDirty()"
                    />
                  </td>

                  <!-- REMOVE -->
                  <td class="ingredients__actions">
                    <button class="btn btn-ghost" (click)="removeIng(ing)">✕</button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </section>
      </aside>

      <!-- ACTIONS -->
      <div class="editor__actions">
        <button class="btn btn-primary" (click)="save()" routerLink="/dishes">Save</button>
      </div>
    </div>
 } @else {
  <app-loader class="editor__loader"></app-loader>
}
</div>
