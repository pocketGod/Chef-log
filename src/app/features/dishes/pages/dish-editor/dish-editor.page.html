<div class="page container">
  <a class="btn btn-ghost" routerLink="/dishes">{{ 'dishEditor.back' | localize }}</a>
  <h1 class="page__title">
  {{ 'dishEditor.title' | localize }}
  <span class="badge">{{ 'dishEditor.badge.setup' | localize }}</span>
</h1>

  @if (dish$ | async; as d) {
    <div class="editor">

      <!-- LEFT COLUMN -->
      <div class="editor__left">
        <!-- Basics -->
        <section class="card editor__card">
          <h3>{{ 'dishEditor.basics.title' | localize }}</h3>
          <div class="form-grid">
            <label class="field">
              <span class="field__label">{{ 'dishEditor.basics.name' | localize }}</span>
              <input [(ngModel)]="local.name" (blur)="save()" />
            </label>

            <label class="field">
              <span class="field__label">{{ 'dishEditor.basics.description' | localize }}</span>
              <textarea
                [(ngModel)]="local.description"
                (blur)="save()"
                rows="3"
                [placeholder]=" 'dishEditor.basics.description.placeholder' | localize"
              ></textarea>
            </label>
          </div>
        </section>

        <!-- Serving & Suitability -->
        <section class="card editor__card">
          <h3>{{ 'dishEditor.serving.title' | localize }}</h3>
          <div class="form-grid form-grid--two">
            <label class="field">
              <span class="field__label">{{ 'dishEditor.serving.basePortions' | localize }}</span>
              <input
                type="number"
                step="0.1"
                min="0"
                [(ngModel)]="local.basePortionPerPerson"
                (blur)="save()"
              />
            </label>

            <label class="field">
              <span class="field__label">{{ 'dishEditor.diet' | localize }}</span>
              <select [(ngModel)]="local.diet" (change)="save()">
                <option value="meat">{{ 'dishEditor.diet.meat' | localize }}</option>
                <option value="dairy">{{ 'dishEditor.diet.dairy' | localize }}</option>
                <option value="seafood">{{ 'dishEditor.diet.seafood' | localize }}</option>
                <option value="vegeterian">{{ 'dishEditor.diet.vegeterian' | localize }}</option>
                <option value="vegan">{{ 'dishEditor.diet.vegan' | localize }}</option>
              </select>
            </label>

            <div class="field field--inline field--span-2">
              <app-check
                [label]="'dishEditor.serving.kidFriendly' | localize"
                [checked]="local.kidFriendly !== false"
                (checkedChange)="setKidFriendly($event)"
              />
            </div>
          </div>
        </section>
      </div>

      <!-- RIGHT COLUMN -->
      <aside class="editor__right">
        <section class="card editor__card">
          <div class="section-header">
            <h3>{{ 'dishEditor.ingredients.title' | localize }}</h3>
            <button class="btn" (click)="addIng()">
            {{ 'dishEditor.ingredients.add' | localize }}
          </button>
          </div>

          <table class="table ingredients">
            <thead>
              <tr>
                <th>{{ 'dishEditor.ingredients.table.name' | localize }}</th>
                <th>{{ 'dishEditor.ingredients.table.unit' | localize }}</th>
                <th>{{ 'dishEditor.ingredients.table.qty' | localize }}</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              @for (ing of local.ingredients; track ing.ingredientId + '_' + ing.unit) {
                <tr>
                  <!-- NAME -->
                  <td>
                    <input
                      [(ngModel)]="ing.ingredientName"
                      (ngModelChange)="onIngNameChange(ing, $event)"
                       [placeholder]="'dishEditor.ingredients.search.placeholder' | localize"
                      [attr.list]="'ingredient-options-' + (ing.ingredientId || 'new')"
                    />
                    <datalist [id]="'ingredient-options-' + (ing.ingredientId || 'new')">
                      @for (opt of suggest; track opt.id) {
                        <option [value]="opt.name">{{ opt.name }}</option>
                      }
                    </datalist>
                  </td>

                  <!-- UNIT -->
                  <td>
                    <select [(ngModel)]="ing.unit" (ngModelChange)="markDirty()">
                      <option value="g">{{ 'common.units.g' | localize }}</option>
                      <option value="kg">{{ 'common.units.kg' | localize }}</option>
                      <option value="ml">{{ 'common.units.ml' | localize }}</option>
                      <option value="l">{{ 'common.units.l' | localize }}</option>
                      <option value="pcs">{{ 'common.units.pcs' | localize }}</option>
                    </select>
                  </td>

                  <!-- QTY -->
                  <td>
                    <input
                      type="number"
                      step="0.01"
                      min="0"
                      [(ngModel)]="ing.qtyPerPortion"
                      (ngModelChange)="markDirty()"
                    />
                  </td>

                  <!-- REMOVE -->
                  <td class="ingredients__actions">
                    <button class="btn btn-ghost" (click)="removeIng(ing)">âœ•</button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </section>
      </aside>

      <!-- ACTIONS -->
      <div class="editor__actions">
        <button class="btn btn-primary" (click)="save()" routerLink="/dishes">{{ 'dishEditor.actions.save' | localize }}</button>
      </div>
    </div>
 } @else {
  <app-loader class="editor__loader"></app-loader>
}
</div>
