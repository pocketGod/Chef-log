<a routerLink="/events">← Back to Events</a>
<h1>Event Editor</h1>

@if (event$ | async; as e) {
<section class="grid gap-4" style="grid-template-columns: 1fr 1fr 1fr">
  <!-- Left: Event details & segments -->
  <div>
    <h3>Details</h3>
    <label>
      Name:
      <input [(ngModel)]="local.name" (blur)="saveName(e.id!)" />
    </label>

    <h3 class="mt-4">Segments</h3>
    <table>
      <thead>
        <tr>
          <th>Key</th>
          <th>Guests</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        @for (s of local.segments; track s.key) {
        <tr>
          <td>
            <select [(ngModel)]="s.key" (ngModelChange)="onSegmentsChange(e.id!)">
              <option *ngFor="let t of GuestTypes" [ngValue]="t">{{ t }}</option>
            </select>
          </td>
          <td>
            <input
              type="number"
              min="0"
              [(ngModel)]="s.guests"
              (ngModelChange)="onSegmentsChange(e.id!)"
            />
          </td>
          <td><button (click)="removeSegment(e.id!, s.key)">✕</button></td>
        </tr>
        }
      </tbody>
    </table>
    <button (click)="addSegment(e.id!)">Add Segment</button>
  </div>

  <!-- Middle: Dishes & popularity -->
  <div>
    <h3>Menu (per-dish popularity)</h3>
    @if (dishes$ | async; as dishes) {
    <ul>
      @for (d of dishes; track d.id) {
      <li style="margin-bottom: 0.75rem">
        <label>
          <input
            type="checkbox"
            [checked]="hasDish(d.id!)"
            (change)="toggleDish(e.id!, d.id!, $event.target.checked)"
          />
          <strong>{{ d.name }}</strong>
          <small> (bpp: {{ bppOf(d.id!) }})</small>
        </label>

        @if (hasDish(d.id!)) {
        <div style="display: flex; align-items: center; gap: 0.5rem">
          <span>Popularity:</span>
          <!-- keep slider responsive locally, persist only on change -->
          <input
            type="range"
            min="0.1"
            max="3"
            step="0.1"
            [ngModel]="localPopularity(d.id!)"
            (ngModelChange)="setLocalPopularity(d.id!, $event)"
            (change)="persistPopularity(e.id!, d.id!)"
          />
          <span>{{ localPopularity(d.id!) }}</span>
        </div>
        }
      </li>
      }
    </ul>
    }
  </div>

  <!-- Right: Live totals -->
  <div>
    <h3>Totals</h3>
    <p>
      Total guests: <strong>{{ totalGuests() }}</strong>
    </p>
    <h4>Dish portions</h4>
    <ul>
      @for (m of local.menu; track m.dishId) {
      <li>
        {{ dishName(m.dishId) }}:
        {{ computePortions(m.dishId, localPopularity(m.dishId)) | number : '1.0-1' }}
        <small> (bpp: {{ bppOf(m.dishId) }})</small>
      </li>
      }
    </ul>
    <!-- Next step: ingredient-level shopping list -->
  </div>
</section>
} @else {
<p>Loading event…</p>
}
